# Supabase 설정 가이드

이 가이드는 영어 AI음성지원 프로그램에서 Supabase를 연동하는 방법을 설명합니다.

## 1. Supabase 프로젝트 생성

1. [Supabase](https://supabase.com) 웹사이트에 접속합니다.
2. boneekim (doyousee2@naver.com) 계정으로 로그인합니다.
3. "New project" 버튼을 클릭합니다.
4. 프로젝트 설정:
   - Name: `english-tutor-ai-voice`
   - Database Password: 안전한 비밀번호 설정
   - Region: Northeast Asia (Seoul) 선택
   - Pricing Plan: Free tier 선택

## 2. 데이터베이스 테이블 생성

Supabase Dashboard의 SQL Editor에서 다음 쿼리를 실행합니다:

```sql
-- english_tutor 테이블 생성 (이미 있다면 컬럼 수정/추가)
-- 기존 테이블이 있는 경우, 필요한 컬럼을 추가하거나 수정
ALTER TABLE public.english_tutor ADD COLUMN IF NOT EXISTS korean text;
ALTER TABLE public.english_tutor ADD COLUMN IF NOT EXISTS english text;
ALTER TABLE public.english_tutor ADD COLUMN IF NOT EXISTS situation text;
ALTER TABLE public.english_tutor ADD COLUMN IF NOT EXISTS user_email text DEFAULT 'doyousee2@naver.com';
ALTER TABLE public.english_tutor ADD COLUMN IF NOT EXISTS created_at timestamp with time zone DEFAULT timezone('utc'::text, now());
ALTER TABLE public.english_tutor ADD COLUMN IF NOT EXISTS updated_at timestamp with time zone DEFAULT timezone('utc'::text, now());

-- 필수 컬럼이 NOT NULL이 되도록 설정
ALTER TABLE public.english_tutor ALTER COLUMN korean SET NOT NULL;
ALTER TABLE public.english_tutor ALTER COLUMN english SET NOT NULL;
ALTER TABLE public.english_tutor ALTER COLUMN situation SET NOT NULL;
ALTER TABLE public.english_tutor ALTER COLUMN user_email SET NOT NULL;
ALTER TABLE public.english_tutor ALTER COLUMN created_at SET NOT NULL;
ALTER TABLE public.english_tutor ALTER COLUMN updated_at SET NOT NULL;

-- 새로 테이블을 만드는 경우 (백업용)
-- create table if not exists public.english_tutor (
--     id bigint generated by default as identity,
--     korean text not null,
--     english text not null,
--     situation text not null,
--     user_email text not null default 'doyousee2@naver.com',
--     created_at timestamp with time zone default timezone('utc'::text, now()) not null,
--     updated_at timestamp with time zone default timezone('utc'::text, now()) not null,
--     constraint english_tutor_pkey primary key (id)
-- );

-- RLS (Row Level Security) 활성화
alter table public.english_tutor enable row level security;

-- 기존 정책 삭제 (있는 경우)
drop policy if exists "Users can insert their own keywords" on public.english_tutor;
drop policy if exists "Users can view their own keywords" on public.english_tutor;
drop policy if exists "Users can update their own keywords" on public.english_tutor;
drop policy if exists "Users can delete their own keywords" on public.english_tutor;
drop policy if exists "Users can insert their own english_tutor" on public.english_tutor;
drop policy if exists "Users can view their own english_tutor" on public.english_tutor;
drop policy if exists "Users can update their own english_tutor" on public.english_tutor;
drop policy if exists "Users can delete their own english_tutor" on public.english_tutor;

-- 사용자별 데이터 접근 정책 생성
create policy "Users can insert their own english_tutor" on public.english_tutor
    for insert with check (user_email = 'doyousee2@naver.com');

create policy "Users can view their own english_tutor" on public.english_tutor
    for select using (user_email = 'doyousee2@naver.com');

create policy "Users can update their own english_tutor" on public.english_tutor
    for update using (user_email = 'doyousee2@naver.com');

create policy "Users can delete their own english_tutor" on public.english_tutor
    for delete using (user_email = 'doyousee2@naver.com');

-- 업데이트 시간 자동 갱신 함수
create or replace function public.handle_updated_at()
returns trigger as $$
begin
    new.updated_at = timezone('utc'::text, now());
    return new;
end;
$$ language plpgsql;

-- 트리거 생성 (기존 트리거가 있다면 삭제 후 재생성)
drop trigger if exists keywords_updated_at on public.english_tutor;
drop trigger if exists english_tutor_updated_at on public.english_tutor;
create trigger english_tutor_updated_at
    before update on public.english_tutor
    for each row
    execute function public.handle_updated_at();
```

## 3. API 키 설정

1. Supabase Dashboard에서 "Settings" > "API" 메뉴로 이동합니다.
2. 다음 정보를 확인합니다:
   - Project URL: `https://your-project-id.supabase.co`
   - anon public key: `eyJ...` (긴 JWT 토큰)

## 4. 프로젝트에 설정 적용

`script.js` 파일에서 다음 부분을 수정합니다:

```javascript
// Supabase 설정
const SUPABASE_URL = 'https://your-project-id.supabase.co'; // 실제 URL로 교체
const SUPABASE_ANON_KEY = 'your-anon-key'; // 실제 키로 교체

// Supabase 클라이언트 초기화
let supabase = null;
try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('Supabase 연결 성공');
} catch (error) {
    console.error('Supabase 연결 실패:', error);
}
```

## 5. 테스트

설정이 완료되면:

1. 웹 애플리케이션을 새로고침합니다.
2. 새 키워드를 추가해보세요.
3. Supabase Dashboard의 "Table Editor"에서 데이터가 저장되는지 확인합니다.

## 문제 해결

### 연결 오류
- URL과 API 키가 정확한지 확인
- 네트워크 연결 상태 확인
- 브라우저 콘솔에서 오류 메시지 확인

### 권한 오류
- RLS 정책이 올바르게 설정되었는지 확인
- 사용자 이메일이 올바른지 확인

### 데이터 저장 오류
- 테이블 스키마가 올바른지 확인
- 필수 필드가 모두 포함되었는지 확인

---

설정 완료 후 키워드 데이터가 Supabase에 안전하게 저장되며, 여러 기기 간 동기화가 가능합니다.
